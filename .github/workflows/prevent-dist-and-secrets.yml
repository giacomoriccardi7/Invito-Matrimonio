name: Prevent dist and secrets

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  guard:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Fail if dist directory is committed
        run: |
          if [ -d "dist" ]; then
            echo "dist/ presente nel commit: vietato."
            exit 1
          fi

      - name: Scan for secrets patterns
        run: |
          set -e
          files_to_scan="src public index.html"
          patterns='(SUPABASE_.*key|VITE_.*KEY|GOOGLE_.*PRIVATE|EMAIL_PASS|SERVICE_ROLE|API_KEY)'
          echo "Scanning for sensitive patterns..."
          match_count=$(grep -REi --exclude-dir=node_modules --exclude-dir=.git --exclude=*.example "$patterns" $files_to_scan | wc -l || true)
          echo "Matches: $match_count"
          if [ "$match_count" -gt 0 ]; then
            echo "Possibili segreti trovati nel codice."
            grep -REi --exclude-dir=node_modules --exclude-dir=.git --exclude=*.example "$patterns" $files_to_scan || true
            exit 1
          fi

      - name: Ensure .env files are not present
        run: |
          set -e
          forbidden=$(git ls-files | grep -E '^\.env$|^server/\.env$' || true)
          if [ -n "$forbidden" ]; then
            echo "File .env committati:"
            echo "$forbidden"
            exit 1
          fi